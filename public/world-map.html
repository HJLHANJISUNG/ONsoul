<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å…¨çƒOHMNANONç²‰ä¸åœ°å›¾</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="languages.js"></script>
    <style>
      .world-map-container {
        padding: 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        margin: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .map-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .map-header h2 {
        font-size: 2.5rem;
        color: #333;
        margin-bottom: 10px;
      }

      .map-header p {
        color: #666;
        font-size: 1.1rem;
      }

      .map-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .location-form {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        margin: 0 auto 30px;
      }

      .location-form h3 {
        text-align: center;
        margin-bottom: 20px;
        color: #333;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #333;
        font-weight: 500;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #eee;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #ff69b4;
      }

      .submit-location-btn {
        width: 100%;
        background: linear-gradient(45deg, #ff69b4, #90ee90);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .submit-location-btn:hover {
        transform: scale(1.02);
      }

      .world-map {
        width: 100%;
        height: 500px;
        background: #f8f9fa;
        border-radius: 15px;
        position: relative;
        overflow: hidden;
        margin-bottom: 30px;
      }

      .map-placeholder {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: #666;
      }

      .map-placeholder i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #ff69b4;
      }

      .user-marker {
        position: absolute;
        width: 20px;
        height: 20px;
        background: #ff69b4;
        border: 3px solid white;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .user-marker:hover {
        transform: scale(1.2);
        box-shadow: 0 4px 20px rgba(255, 105, 180, 0.4);
      }

      .user-tooltip {
        position: absolute;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        font-size: 0.9rem;
        z-index: 1000;
        display: none;
        max-width: 200px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #ff69b4;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #666;
        font-size: 0.9rem;
      }

      .country-chart {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .country-chart h3 {
        text-align: center;
        margin-bottom: 20px;
        color: #333;
      }

      .back-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        background: linear-gradient(45deg, #ff69b4, #90ee90);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.3s ease;
        z-index: 1000;
      }

      .back-btn:hover {
        transform: scale(1.05);
      }

      @media (max-width: 768px) {
        .world-map {
          height: 300px;
        }

        .map-controls {
          flex-direction: column;
          align-items: center;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <button class="back-btn" onclick="window.location.href='index.html'">
      <i class="fas fa-arrow-left"></i> è¿”å›é¦–é¡µ
    </button>

    <div class="world-map-container">
      <div class="map-header">
        <h2>ğŸŒ å…¨çƒOHMNANONç²‰ä¸åœ°å›¾</h2>
        <p>çœ‹çœ‹ä¸–ç•Œå„åœ°çš„ç²‰ä¸éƒ½åœ¨å“ªé‡Œæ”¯æŒOHMNANONï¼</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalUsers">0</div>
          <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalCountries">0</div>
          <div class="stat-label">æ¶‰åŠå›½å®¶</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalCities">0</div>
          <div class="stat-label">æ¶‰åŠåŸå¸‚</div>
        </div>
      </div>

      <div class="location-form">
        <h3>ğŸ“ æ·»åŠ ä½ çš„ä½ç½®</h3>
        <form id="locationForm">
          <div class="form-group">
            <label for="username">ä½ çš„æ˜µç§°</label>
            <input
              type="text"
              id="username"
              required
              placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°"
            />
          </div>
          <div class="form-group">
            <label for="country">å›½å®¶</label>
            <select id="country" required>
              <option value="">è¯·é€‰æ‹©å›½å®¶</option>
              <option value="ä¸­å›½">ä¸­å›½</option>
              <option value="æ³°å›½">æ³°å›½</option>
              <option value="æ—¥æœ¬">æ—¥æœ¬</option>
              <option value="éŸ©å›½">éŸ©å›½</option>
              <option value="ç¾å›½">ç¾å›½</option>
              <option value="åŠ æ‹¿å¤§">åŠ æ‹¿å¤§</option>
              <option value="è‹±å›½">è‹±å›½</option>
              <option value="æ³•å›½">æ³•å›½</option>
              <option value="å¾·å›½">å¾·å›½</option>
              <option value="æ¾³å¤§åˆ©äºš">æ¾³å¤§åˆ©äºš</option>
              <option value="æ–°åŠ å¡">æ–°åŠ å¡</option>
              <option value="é©¬æ¥è¥¿äºš">é©¬æ¥è¥¿äºš</option>
              <option value="è²å¾‹å®¾">è²å¾‹å®¾</option>
              <option value="å°åº¦å°¼è¥¿äºš">å°åº¦å°¼è¥¿äºš</option>
              <option value="è¶Šå—">è¶Šå—</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          <div class="form-group">
            <label for="city">åŸå¸‚</label>
            <input
              type="text"
              id="city"
              required
              placeholder="è¯·è¾“å…¥ä½ çš„åŸå¸‚"
            />
          </div>
          <button type="submit" class="submit-location-btn">
            <i class="fas fa-map-marker-alt"></i> æ·»åŠ ä½ç½®
          </button>
        </form>
      </div>

      <div class="world-map" id="worldMap">
        <div class="map-placeholder">
          <i class="fas fa-globe-americas"></i>
          <p>æ­£åœ¨åŠ è½½å…¨çƒç²‰ä¸åˆ†å¸ƒ...</p>
        </div>
      </div>

      <div class="country-chart">
        <h3>ğŸ“Š å›½å®¶ç²‰ä¸åˆ†å¸ƒ</h3>
        <canvas id="countryChart" width="400" height="200"></canvas>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:3000/api";
      let userLocations = [];
      let countryStats = [];

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        // åˆå§‹åŒ–è¯­è¨€ç®¡ç†å™¨
        if (window.languageManager) {
          window.languageManager.updatePageText();
        }

        loadUserLocations();
        loadCountryStats();
        initializeLocationForm();
      });

      // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶
      document.addEventListener("languageChanged", function (e) {
        updateWorldMapText();
      });

      // åŠ è½½ç”¨æˆ·ä½ç½®ä¿¡æ¯
      async function loadUserLocations() {
        try {
          const response = await fetch(`${API_BASE_URL}/user-locations`);
          const data = await response.json();
          userLocations = data.locations;
          displayUserMarkers();
          updateStats();
        } catch (error) {
          console.error("åŠ è½½ç”¨æˆ·ä½ç½®å¤±è´¥:", error);
        }
      }

      // åŠ è½½å›½å®¶ç»Ÿè®¡
      async function loadCountryStats() {
        try {
          const response = await fetch(`${API_BASE_URL}/country-stats`);
          const data = await response.json();
          countryStats = data.stats;
          createCountryChart();
        } catch (error) {
          console.error("åŠ è½½å›½å®¶ç»Ÿè®¡å¤±è´¥:", error);
        }
      }

      // æ˜¾ç¤ºç”¨æˆ·æ ‡è®°
      function displayUserMarkers() {
        const mapContainer = document.getElementById("worldMap");
        mapContainer.innerHTML = "";

        // ç®€åŒ–çš„ä¸–ç•Œåœ°å›¾åæ ‡æ˜ å°„
        const countryCoordinates = {
          ä¸­å›½: { x: 75, y: 45 },
          æ³°å›½: { x: 70, y: 55 },
          æ—¥æœ¬: { x: 85, y: 40 },
          éŸ©å›½: { x: 80, y: 42 },
          ç¾å›½: { x: 20, y: 45 },
          åŠ æ‹¿å¤§: { x: 20, y: 35 },
          è‹±å›½: { x: 45, y: 40 },
          æ³•å›½: { x: 48, y: 42 },
          å¾·å›½: { x: 50, y: 42 },
          æ¾³å¤§åˆ©äºš: { x: 80, y: 70 },
          æ–°åŠ å¡: { x: 72, y: 58 },
          é©¬æ¥è¥¿äºš: { x: 70, y: 58 },
          è²å¾‹å®¾: { x: 75, y: 58 },
          å°åº¦å°¼è¥¿äºš: { x: 72, y: 62 },
          è¶Šå—: { x: 72, y: 55 },
        };

        userLocations.forEach((location, index) => {
          const coords = countryCoordinates[location.country];
          if (coords) {
            const marker = document.createElement("div");
            marker.className = "user-marker";
            marker.style.left = coords.x + "%";
            marker.style.top = coords.y + "%";
            marker.style.animationDelay = index * 0.1 + "s";

            // æ·»åŠ ç”¨æˆ·ä¿¡æ¯æç¤º
            marker.addEventListener("mouseenter", () => {
              showTooltip(marker, location);
            });

            marker.addEventListener("mouseleave", () => {
              hideTooltip();
            });

            mapContainer.appendChild(marker);
          }
        });

        // æ·»åŠ ä¸–ç•Œåœ°å›¾èƒŒæ™¯
        const mapBackground = document.createElement("div");
        mapBackground.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
                opacity: 0.3;
                z-index: -1;
            `;
        mapContainer.appendChild(mapBackground);
      }

      // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯æç¤º
      function showTooltip(marker, location) {
        const tooltip = document.createElement("div");
        tooltip.className = "user-tooltip";
        tooltip.innerHTML = `
                <strong>${location.username}</strong><br>
                ${location.country} - ${location.city}
            `;

        const rect = marker.getBoundingClientRect();
        tooltip.style.left = rect.left + "px";
        tooltip.style.top = rect.top - 60 + "px";
        tooltip.style.display = "block";

        document.body.appendChild(tooltip);
      }

      // éšè—æç¤º
      function hideTooltip() {
        const tooltips = document.querySelectorAll(".user-tooltip");
        tooltips.forEach((tooltip) => tooltip.remove());
      }

      // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      function updateStats() {
        const totalUsers = userLocations.length;
        const totalCountries = new Set(userLocations.map((l) => l.country))
          .size;
        const totalCities = new Set(userLocations.map((l) => l.city)).size;

        document.getElementById("totalUsers").textContent = totalUsers;
        document.getElementById("totalCountries").textContent = totalCountries;
        document.getElementById("totalCities").textContent = totalCities;
      }

      // åˆ›å»ºå›½å®¶åˆ†å¸ƒå›¾è¡¨
      function createCountryChart() {
        const ctx = document.getElementById("countryChart").getContext("2d");

        const labels = countryStats.map((stat) => stat.country);
        const data = countryStats.map((stat) => stat.count);
        const colors = [
          "#FF69B4",
          "#90EE90",
          "#87CEEB",
          "#DDA0DD",
          "#F0E68C",
          "#FFB6C1",
          "#98FB98",
          "#ADD8E6",
          "#E6E6FA",
          "#F0F8FF",
        ];

        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: "white",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                },
              },
            },
          },
        });
      }

      // åˆå§‹åŒ–ä½ç½®è¡¨å•
      function initializeLocationForm() {
        const form = document.getElementById("locationForm");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const username = document.getElementById("username").value;
          const country = document.getElementById("country").value;
          const city = document.getElementById("city").value;

          if (!username || !country || !city) {
            alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼");
            return;
          }

          try {
            const response = await fetch(`${API_BASE_URL}/user-location`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                username: username,
                country: country,
                city: city,
              }),
            });

            if (response.ok) {
              const result = await response.json();
              alert(result.message);

              // é‡æ–°åŠ è½½æ•°æ®
              await loadUserLocations();
              await loadCountryStats();

              // æ¸…ç©ºè¡¨å•
              form.reset();
            } else {
              const error = await response.json();
              alert(`æäº¤å¤±è´¥: ${error.error}`);
            }
          } catch (error) {
            console.error("æäº¤ä½ç½®ä¿¡æ¯å¤±è´¥:", error);
            alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•");
          }
        });
      }

      // æ›´æ–°ä¸–ç•Œåœ°å›¾é¡µé¢æ–‡æœ¬
      function updateWorldMapText() {
        if (!window.languageManager) return;

        const lang = window.languageManager;

        // æ›´æ–°é¡µé¢æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
        const title = document.querySelector(".map-header h2");
        const subtitle = document.querySelector(".map-header p");
        if (title) title.textContent = lang.getText("worldMap.title");
        if (subtitle) subtitle.textContent = lang.getText("worldMap.subtitle");

        // æ›´æ–°ç»Ÿè®¡æ ‡ç­¾
        const statLabels = document.querySelectorAll(".stat-label");
        if (statLabels[0])
          statLabels[0].textContent = lang.getText("worldMap.stats.totalUsers");
        if (statLabels[1])
          statLabels[1].textContent = lang.getText(
            "worldMap.stats.totalCountries"
          );
        if (statLabels[2])
          statLabels[2].textContent = lang.getText(
            "worldMap.stats.totalCities"
          );

        // æ›´æ–°è¡¨å•
        const formTitle = document.querySelector(".location-form h3");
        const usernameLabel = document.querySelector('label[for="username"]');
        const countryLabel = document.querySelector('label[for="country"]');
        const cityLabel = document.querySelector('label[for="city"]');
        const submitBtn = document.querySelector(".submit-location-btn");

        if (formTitle)
          formTitle.textContent = lang.getText("worldMap.addLocation");
        if (usernameLabel)
          usernameLabel.textContent = lang.getText("worldMap.username");
        if (countryLabel)
          countryLabel.textContent = lang.getText("worldMap.country");
        if (cityLabel) cityLabel.textContent = lang.getText("worldMap.city");
        if (submitBtn)
          submitBtn.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${lang.getText(
            "worldMap.submit"
          )}`;

        // æ›´æ–°è¾“å…¥æ¡†å ä½ç¬¦
        const usernameInput = document.getElementById("username");
        const cityInput = document.getElementById("city");
        if (usernameInput)
          usernameInput.placeholder = lang.getText(
            "worldMap.usernamePlaceholder"
          );
        if (cityInput)
          cityInput.placeholder = lang.getText("worldMap.cityPlaceholder");

        // æ›´æ–°å›½å®¶é€‰æ‹©å™¨
        updateCountrySelect();

        // æ›´æ–°å›¾è¡¨æ ‡é¢˜
        const chartTitle = document.querySelector(".country-chart h3");
        if (chartTitle)
          chartTitle.textContent = lang.getText(
            "worldMap.stats.countryDistribution"
          );
      }

      // æ›´æ–°å›½å®¶é€‰æ‹©å™¨
      function updateCountrySelect() {
        if (!window.languageManager) return;

        const countrySelect = document.getElementById("country");
        if (!countrySelect) return;

        const lang = window.languageManager;
        const currentValue = countrySelect.value;

        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        countrySelect.innerHTML = "";

        // æ·»åŠ é»˜è®¤é€‰é¡¹
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = lang.getText("worldMap.selectCountry");
        countrySelect.appendChild(defaultOption);

        // æ·»åŠ å›½å®¶é€‰é¡¹
        const countries = [
          "china",
          "thailand",
          "japan",
          "korea",
          "usa",
          "canada",
          "uk",
          "france",
          "germany",
          "australia",
          "singapore",
          "malaysia",
          "philippines",
          "indonesia",
          "vietnam",
          "other",
        ];

        countries.forEach((country) => {
          const option = document.createElement("option");
          option.value = lang.getText(`worldMap.countries.${country}`);
          option.textContent = lang.getText(`worldMap.countries.${country}`);
          countrySelect.appendChild(option);
        });

        // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
        if (currentValue) {
          countrySelect.value = currentValue;
        }
      }

      // å®šæœŸåˆ·æ–°æ•°æ®
      setInterval(() => {
        loadUserLocations();
        loadCountryStats();
      }, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
    </script>
  </body>
</html>
